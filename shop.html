<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Shop</title>
    <link rel="stylesheet" href="style.css">
</head>
<body style="height:auto;">

    <nav style="background:white; padding:20px; border-bottom:1px solid #eee; position:sticky; top:0;">
        <div style="max-width:1000px; margin:0 auto; display:flex; justify-content:space-between; align-items:center;">
            <h2 id="store-title" style="margin:0; color:var(--primary);">Store</h2>
            <button class="btn" style="width:auto;" onclick="checkout()">Cart (<span id="cart-count">0</span>)</button>
        </div>
    </nav>

    <div class="container" style="max-width:1000px; margin:30px auto; padding:0 20px;">
        <div id="product-list" class="grid">Loading...</div>
    </div>

    <script type="module">
        import { db } from './firebase-config.js';
        import { collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const params = new URLSearchParams(window.location.search);
        const storeId = params.get('store');
        let cart = [];

        if(!storeId) document.body.innerHTML = "<h1>Store Not Found</h1>";
        else loadStore();

        async function loadStore() {
            // 1. Get Merchant Info to find Agency Branding
            // (For simplicity in this demo, we skip fetching Agency color here, but you can add it)
            
            // 2. Load Products
            const snap = await getDocs(collection(db, "shops", storeId, "products"));
            const list = document.getElementById('product-list');
            list.innerHTML = "";
            
            snap.forEach(d => {
                const p = d.data();
                const btn = document.createElement('button');
                btn.className = "btn";
                btn.innerText = "Add to Cart";
                btn.onclick = () => { cart.push(p); document.getElementById('cart-count').innerText = cart.length; };

                list.innerHTML += `
                    <div class="product-card">
                        <div class="product-img" style="background-image:url('${p.image || 'https://via.placeholder.com/300'}')"></div>
                        <div class="product-info">
                            <h3>${p.title}</h3>
                            <p style="font-weight:bold; font-size:1.2rem;">${p.price}</p>
                            <button class="btn" onclick="addToCart('${p.title}', '${p.price}')">Add to Cart</button>
                        </div>
                    </div>
                `;
            });
        }
        
        window.addToCart = (title, price) => {
            cart.push({title, price});
            document.getElementById('cart-count').innerText = cart.length;
        };

        window.checkout = () => {
            if(cart.length === 0) return alert("Cart is empty");
            let msg = "Hi, I want to order:%0A";
            let total = 0;
            cart.forEach(i => { msg += `- ${i.title} (${i.price})%0A`; total += parseFloat(i.price); });
            msg += `%0ATotal: ${total}`;
            
            // In a real app, you fetch the merchant's phone number from DB
            const merchantPhone = prompt("Enter Merchant WhatsApp Number (Demo Mode):", "9477.......");
            if(merchantPhone) window.open(`https://wa.me/${merchantPhone}?text=${msg}`, '_blank');
        };
    </script>
</body>
</html>
